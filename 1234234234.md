# Aliana Protocol 服务器部署指南

本指南详细说明如何在 Linux 服务器（推荐 Ubuntu 22.04 LTS）上部署 Aliana Protocol 的前端和后端服务。

## 1. 服务器基础环境准备

### 1.1 系统更新
首先确保服务器系统是最新的：
```bash
sudo apt update && sudo apt upgrade -y
```

### 1.2 安装必要工具
安装 Git、Curl 和构建工具：
```bash
sudo apt install -y git curl build-essential
```

### 1.3 安装 Node.js (推荐 v20 LTS)
使用 NodeSource 安装 Node.js v20：
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```
验证安装：
```bash
node -v  # 应输出 v20.x.x
npm -v   # 应输出 10.x.x
```

### 1.4 安装 PM2 进程管理器
用于后台运行前端服务：
```bash
sudo npm install -g pm2
```

## 2. 代码获取

由于您已将 `docs` 和 `test` 排除在 Git 之外，但核心代码仍在仓库中，您可以通过 Git 拉取代码。

```bash
# 假设您已设置好 SSH key 或使用 HTTPS
git clone <您的仓库地址> aliana
cd aliana
```

## 3. 智能合约 (后端) 设置

虽然合约通常部署在区块链上，但您可能需要在服务器上运行脚本或验证。

### 3.1 安装依赖
```bash
npm install
```

### 3.2 环境变量配置
复制示例配置文件并填入您的私钥和 API Key：
```bash
cp .env.example .env  # 如果没有示例文件，请直接创建
nano .env
```
`.env` 文件内容参考：
```env
PRIVATE_KEY=您的钱包私钥
BSC_TESTNET_URL=https://data-seed-prebsc-1-s1.binance.org:8545/
BSCSCAN_API_KEY=您的BscScanAPIKey
```

### 3.3 编译合约
```bash
npx hardhat compile
```

## 4. 前端应用部署

### 4.1 进入前端目录
```bash
cd frontend
```

### 4.2 安装依赖
```bash
npm install
```

### 4.3 环境变量配置
创建 `.env.local` 文件：
```bash
nano .env.local
```
根据您的项目需求填入必要的环境变量（如 WalletConnect Project ID 等）。

### 4.4 构建应用
```bash
npm run build
```

### 4.5 启动服务
使用 PM2 启动 Next.js 应用：
```bash
pm2 start npm --name "aliana-frontend" -- start
```
保存 PM2 进程列表，以便开机自启：
```bash
pm2 save
pm2 startup
```

## 5. Nginx 反向代理配置 (推荐)

为了让外部用户通过域名访问，建议使用 Nginx 作为反向代理。

### 5.1 安装 Nginx
```bash
sudo apt install -y nginx
```

### 5.2 配置 Nginx
创建配置文件：
```bash
sudo nano /etc/nginx/sites-available/aliana
```
填入以下内容（替换 `your_domain.com` 为您的域名）：
```nginx
server {
    listen 80;
    server_name your_domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 5.3 启用配置并重启 Nginx
```bash
sudo ln -s /etc/nginx/sites-available/aliana /etc/nginx/sites-enabled/
sudo nginx -t # 测试配置是否正确
sudo systemctl restart nginx
```

### 5.4 配置 SSL (HTTPS)
推荐使用 Certbot 自动配置免费 SSL 证书：
```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your_domain.com
```

## 6. 日常维护

### 6.1 更新代码
```bash
cd ~/aliana
git pull
cd frontend
npm install
npm run build
pm2 restart aliana-frontend
```

### 6.2 查看日志
```bash
pm2 logs aliana-frontend
```
